set.seed(0102)
options(htmlwidgets.TOJSON_ARGS = list(pretty = TRUE), htmltools.dir.version = FALSE)
Sys.setenv(R_KNITR_OPTIONS = 'knitr.chunk.tidy=FALSE')

# remove the <div> tags around <pre>, and clean up <a> on all lines
clean_pandoc2_highlight_tags = function(x) {
  x = gsub('(</code></pre>)</div>', '\\1', x)
  x = gsub('<div class="sourceCode"[^>]+>(<pre)', '\\1', x)
  x = gsub('<a class="sourceLine"[^>]+>(.*)</a>', '\\1', x)
  x
}

library(DT)
o = rmarkdown::render(commandArgs(TRUE), quiet = TRUE)
x = gsub('\\u003c', '<', readLines(o), fixed = TRUE)
x = gsub('<\\\\(/[a-z1-6]+>)', '<\\1', x)
x = blogdown:::clean_widget_html(x)
x = clean_pandoc2_highlight_tags(x)
x = x[x != 'pre.sourceCode { margin: 0; }']
x = gsub('^(<style type="text/css")( data-origin="pandoc")(>)$', '\\1\\3', x)
writeLines(x, o)
unlink(list.files('.', '[.]map$', recursive = TRUE))
unlink(c(
  'libs/bootstrap/js/npm.js', 'libs/bootstrap/js/bootstrap.js',
  'libs/bootstrap/css/bootstrap.css', 'libs/bootstrap/css/bootstrap.min.css',
  'libs/bootstrap/css/bootstrap-theme.css', 'libs/bootstrap/css/bootstrap-theme.min.css',
  sprintf(
    'libs/bootstrap/css/%s.min.css',
    c('cerulean', 'cosmo', 'journal', 'lumen', 'paper', 'readable', 'sandstone', 'simplex', 'spacelab', 'united', 'yeti')
  )
))
